generator client {
  provider = "prisma-client-js"
  output   = "../src/prisma/client"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model Team {
  id   Int    @id @default(autoincrement())
  name String @default("") @db.VarChar(255)
  slug String @unique @db.VarChar(64)

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  memberships Membership[]
  tags        Tag[]
  AssetObject AssetObject[]
}

model User {
  id   Int    @id @default(autoincrement())
  name String @default("") @db.VarChar(255)
  slug String @unique @db.VarChar(64)

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  memberships Membership[]
}

model Membership {
  id     Int  @id @default(autoincrement())
  userId Int  @unique
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  teamId Int  @unique
  team   Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  @@unique([userId, teamId])
}

model AssetObject {
  id               Int    @id @default(autoincrement())
  teamId           Int
  team             Team   @relation(fields: [teamId], references: [id])
  slug             String @unique @db.VarChar(64)
  materializedPath String
  name             String
  description      String
  tags             Json   @default("[]") // string[]
  content          Json   @default("{}") // Record<string, string>

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)
}

model Tag {
  id     Int  @id @default(autoincrement())
  teamId Int
  team   Team @relation(fields: [teamId], references: [id])

  name     String @db.VarChar(100)
  level    Int    @default(1) // 层级: 1, 2, 3
  parentId Int?
  parent   Tag?   @relation("TagHierarchy", fields: [parentId], references: [id])
  children Tag[]  @relation("TagHierarchy")

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  @@unique([teamId, level, name])
}
