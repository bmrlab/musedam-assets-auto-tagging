# 管理员功能测试指南

本文档提供了 MuseDAM 管理员功能的完整测试指南。

## 前置条件

1. **系统已部署并运行**：

   ```bash
   pnpm dev
   ```

2. **数据库已初始化**：

   ```bash
   npx prisma db push
   ```

3. **至少有一个管理员账户**

## 创建测试用户和管理员

### 1. 注册测试用户

访问 http://localhost:3000/register 并创建以下测试用户：

```
用户1 (将提升为管理员):
- 姓名: 系统管理员
- 邮箱: admin@test.com
- 密码: password123

用户2 (普通用户):
- 姓名: 张三
- 邮箱: zhangsan@test.com
- 密码: password123

用户3 (普通用户):
- 姓名: 李四
- 邮箱: lisi@test.com
- 密码: password123

用户4 (普通用户):
- 姓名: 王五
- 邮箱: wangwu@test.com
- 密码: password123
```

### 2. 提升管理员权限

```bash
pnpm make-admin admin@test.com
```

## 用户管理功能测试

### 访问管理员面板

1. 使用管理员账户登录：http://localhost:3000/login
2. 访问管理员面板：http://localhost:3000/admin
3. 验证重定向到用户管理页面：http://localhost:3000/admin/users

### 测试用户列表功能

**预期结果**：

- ✅ 显示所有已注册用户
- ✅ 显示用户姓名、邮箱、角色、状态
- ✅ 显示创建时间
- ✅ 显示操作按钮（管理）

### 测试用户搜索功能

1. 在搜索框中输入 "zhang"
2. **预期结果**：只显示张三的用户记录

### 测试创建用户功能

1. 点击"创建用户"按钮
2. 填写表单：
   ```
   邮箱: test-new@example.com
   姓名: 测试新用户
   密码: newpass123
   角色: 普通用户
   ```
3. 点击"创建用户"
4. **预期结果**：
   - ✅ 创建成功提示
   - ✅ 用户列表更新，显示新用户
   - ✅ 新用户角色为 "user"

### 测试用户角色管理

1. 点击张三用户的"管理"按钮
2. 点击"管理员"按钮，将张三提升为管理员
3. **预期结果**：
   - ✅ 角色更新成功
   - ✅ 张三的角色标签变为"管理员"

### 测试用户封禁功能

1. 点击李四用户的"管理"按钮
2. 点击"封禁用户"按钮
3. **预期结果**：
   - ✅ 封禁成功
   - ✅ 李四的状态变为"已封禁"

### 测试用户解封功能

1. 点击李四用户的"管理"按钮
2. 点击"解除封禁"按钮
3. **预期结果**：
   - ✅ 解封成功
   - ✅ 李四的状态变为"正常"

## 组织管理功能测试

### 访问组织管理页面

1. 在用户管理页面点击"组织管理"按钮
2. 或直接访问：http://localhost:3000/admin/organizations
3. **预期结果**：显示组织管理界面

### 测试创建组织功能

#### 创建第一个组织

1. 点击"创建组织"按钮
2. 填写表单：
   ```
   组织名称: 测试科技公司
   组织标识符: test-tech-corp
   Logo URL: https://via.placeholder.com/150/0066cc/ffffff?text=TTC
   ```
3. 点击"创建组织"
4. **预期结果**：
   - ✅ 组织创建成功
   - ✅ 组织列表显示新创建的组织
   - ✅ 显示组织名称、标识符、成员数量、创建时间

#### 创建第二个组织

1. 重复上述步骤，创建：
   ```
   组织名称: 创新设计工作室
   组织标识符: design-studio
   Logo URL: https://via.placeholder.com/150/ff6600/ffffff?text=DS
   ```

### 测试添加组织成员功能

#### 为第一个组织添加成员

1. 在"测试科技公司"组织卡片中点击"添加成员"
2. 选择用户"张三 (zhangsan@test.com)"
3. 选择角色"所有者"
4. 点击"添加成员"
5. **预期结果**：
   - ✅ 成员添加成功（使用服务端 addMember API 直接添加）
   - ✅ 组织成员列表显示张三
   - ✅ 张三的角色显示为"所有者"
   - ✅ 组织成员数量更新为 1
   - ✅ 无需邀请确认流程，立即生效

#### 添加更多成员

重复上述步骤，添加：

- 李四 - 角色：管理员
- 王五 - 角色：成员

### 测试成员角色管理功能

1. 在成员列表中点击李四的"编辑"按钮
2. 点击"设为所有者"
3. **预期结果**：
   - ✅ 角色更新成功
   - ✅ 李四的角色标签变为"所有者"

### 测试移除成员功能

1. 在成员列表中点击王五的"移除"按钮
2. 确认移除操作
3. **预期结果**：
   - ✅ 成员移除成功
   - ✅ 王五不再出现在成员列表中
   - ✅ 组织成员数量减少

### 测试删除组织功能

1. 在"创新设计工作室"组织卡片中点击"删除组织"
2. 确认删除操作
3. **预期结果**：
   - ✅ 组织删除成功
   - ✅ 组织不再出现在组织列表中

## 导航和权限测试

### 测试页面导航

1. **面包屑导航测试**：
   - 在用户管理页面点击"首页" → 应跳转到主页
   - 在组织管理页面点击"首页" → 应跳转到主页

2. **页面间跳转测试**：
   - 用户管理页面 → 组织管理页面
   - 组织管理页面 → 用户管理页面

3. **组织切换功能测试**：
   - 组织切换器显示测试
   - 组织切换功能测试
   - 个人模式切换测试

### 测试权限控制

#### 普通用户权限测试

1. 退出管理员账户
2. 使用普通用户账户登录（如：zhangsan@test.com）
3. 尝试访问 http://localhost:3000/admin/users
4. **预期结果**：
   - ✅ 显示"访问被拒绝"页面
   - ✅ 提示没有权限访问管理员面板

#### 主页管理员入口测试

1. 使用管理员账户登录
2. 访问主页：http://localhost:3000
3. **预期结果**：
   - ✅ 显示"管理员功能"区域
   - ✅ 显示"进入管理面板"按钮
   - ✅ 点击按钮可跳转到管理面板

## 组织切换功能测试

### 测试组织切换器显示

**前提条件**：用户至少属于一个组织

1. 使用有组织成员身份的用户登录
2. 查看页面右上角工具栏
3. **预期结果**：
   - ✅ 显示组织切换器按钮
   - ✅ 显示当前活跃组织名称或"个人模式"
   - ✅ 显示下拉箭头图标

### 测试组织切换功能

1. 点击组织切换器按钮
2. **预期结果**：
   - ✅ 打开组织选择下拉菜单
   - ✅ 显示"个人模式"选项
   - ✅ 显示所有用户所属的组织
   - ✅ 当前活跃组织有选中标识（蓝色背景和勾选图标）

3. 选择不同的组织
4. **预期结果**：
   - ✅ 组织切换成功
   - ✅ 切换器显示新的组织名称
   - ✅ 主页显示当前组织信息
   - ✅ 下拉菜单关闭

### 测试个人模式切换

1. 点击组织切换器
2. 选择"个人模式"
3. **预期结果**：
   - ✅ 切换器显示"个人模式"
   - ✅ 主页显示个人模式提示
   - ✅ 组织上下文被清除

### 测试组织信息显示

1. 切换到有Logo的组织
2. **预期结果**：
   - ✅ 组织Logo正确显示
   - ✅ 组织名称和标识符正确显示

3. 切换到没有Logo的组织
4. **预期结果**：
   - ✅ 显示组织名称首字母作为默认头像

### 测试主页组织状态显示

1. 在有活跃组织的状态下访问主页
2. **预期结果**：
   - ✅ 页面标题下显示"当前组织: [组织名称]"
   - ✅ 显示蓝色组织信息卡片
   - ✅ 卡片内显示组织Logo和名称

3. 切换到个人模式后刷新主页
4. **预期结果**：
   - ✅ 不显示组织信息
   - ✅ 显示灰色个人模式提示卡片

## 错误处理测试

### 测试表单验证

#### 用户创建表单验证

1. 点击"创建用户"，尝试提交空表单
2. **预期结果**：显示必填字段验证错误

3. 尝试创建已存在邮箱的用户
4. **预期结果**：显示邮箱已存在错误

#### 组织创建表单验证

1. 点击"创建组织"，尝试提交空表单
2. **预期结果**：显示必填字段验证错误

3. 尝试创建已存在标识符的组织
4. **预期结果**：显示标识符已存在错误

### 测试网络错误处理

模拟网络错误（可通过浏览器开发工具阻止网络请求）：

1. **预期结果**：显示友好的错误提示信息
2. **预期结果**：不会导致页面崩溃

## 性能测试

### 测试大量数据处理

1. 创建多个组织（5-10个）
2. 为每个组织添加多个成员
3. **预期结果**：
   - ✅ 页面加载流畅
   - ✅ 操作响应及时
   - ✅ 数据显示正确

## 测试检查清单

### 用户管理功能 ✅

- [ ] 用户列表显示
- [ ] 用户搜索功能
- [ ] 创建新用户
- [ ] 角色管理（提升/降级）
- [ ] 用户封禁/解封
- [ ] 权限验证

### 组织管理功能 ✅

- [ ] 组织列表显示
- [ ] 创建新组织
- [ ] 添加组织成员
- [ ] 成员角色管理
- [ ] 移除组织成员
- [ ] 删除组织

### 界面和导航 ✅

- [ ] 面包屑导航
- [ ] 页面间跳转
- [ ] 响应式设计
- [ ] 加载状态显示
- [ ] 错误提示显示

### 组织切换功能 ✅

- [ ] 组织切换器显示
- [ ] 组织列表展示
- [ ] 组织切换功能
- [ ] 个人模式切换
- [ ] 活跃组织状态显示
- [ ] 主页组织信息显示

### 安全和权限 ✅

- [ ] 管理员权限验证
- [ ] 普通用户访问限制
- [ ] 会话管理
- [ ] 退出登录功能

## 故障排除

### 常见问题

1. **无法访问管理面板**
   - 确认用户已被提升为管理员
   - 检查是否已登录

2. **组织操作失败**
   - 检查网络连接
   - 查看浏览器控制台错误信息

3. **数据不更新**
   - 刷新页面
   - 检查数据库连接

### 日志查看

开发环境下，检查终端输出的日志信息以诊断问题。

## 测试完成标准

所有功能测试通过后，系统应该：

1. ✅ 支持完整的用户生命周期管理
2. ✅ 支持完整的组织和成员管理（使用直接添加方式）
3. ✅ 具有良好的用户体验和错误处理
4. ✅ 确保适当的权限控制和安全性
5. ✅ 界面响应流畅，导航清晰
6. ✅ 成员添加无需邀请确认，使用服务端 API 直接生效
7. ✅ 用户可以在不同组织间自由切换工作上下文
8. ✅ 组织切换状态正确保持和显示

测试完成后，系统即可投入使用或部署到生产环境。
